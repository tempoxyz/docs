# Rewards Distribution

## Abstract

This specification defines an efficient mechanism for token issuers to reward token holders proportional to their holdings. The mechanism is integrated into the token, maintains low costs at scale, complies with TIP-403 registry requirements, and supports streaming rewards linearly over a time period and instant rewards.

## Motivation

Many applications (such as incentive programs, reward distribution, deterministic inflation, and staking) often require pro-rata distribution of some tokens to existing holders of that token.
Traditional reward mechanisms require tokens to be staked in separate contracts, which fragments user holdings and adds complexity to wallet implementations to maintain a coherent balance view.

## Specification

The rewards mechanism allows anyone to distribute token rewards to a set of token holders in the same token. Rewards accrue proportional based on holdings, and can be distributed over a duration linearly or as an instant payment.

Users must opt in to receiving rewards. Once opted in, rewards accrue to a separate reward pool that users can withdraw from at any point. Users may also delegate rewards to a recipient address to receive their rewards instead.

Reward payments comply with TIP-403 registry policies. See [TIP-403](./tip-403.mdx) for details.

### Technical Implementation

The rewards mechanism uses an accumulator pattern for efficiency.

Each token maintains a `totalRewardPerSecond` variable representing the summed emission rate of all active streaming rewards. This aggregate rate variable is increased when new streams start, and is decreased when streams end or are cancelled.

A `globalRewardPerToken` accumulator tracks cumulative rewards per unit token, scaled by 1e18. On each update, the system adds `(totalRewardPerSecond * elapsed) / optedInSupply` to the accumulator for streaming rewards, where `totalRewardPerSecond` is already scaled by 1e18. For instant distributions, it adds `(amount * 1e18) / optedInSupply` directly to the accumulator.

Each user stores a local `rewardPerToken` snapshot capturing the `globalRewardPerToken` value at their last interaction. Pending rewards for any user are calculated as: `(globalRewardPerToken - rewardPerToken) * userBalance`.

### Rewards Architecture

The rewards distribution system contains two components:
1. Rewards tracking logic integrated into TIP-20 tokens
2. A TIP-20 rewards registry that uses system transactions to ensure the correctness of reward streams

### System Transactions

Reward streams are automatically finalized through system transactions, coordinated by the TIP-20 rewards registry. When a token creates a stream, it registers the end time with the registry. When streams are canceled, tokens unregister the end time if no other streams end at that moment. Then, at the start of each block, the registry triggers finalization callbacks on all tokens with streams ending at that timestamp.

The interface for the TIP-20 rewards registry is shown below. `addStream` and `removeStream` are callable only by TIP-20 tokens, and `finalizeStreams` can only be called by `address(0)`.

```solidity
interface TIP20RewardsRegistry {
    function addStream(uint128 timestamp) external;
    function removeStream(uint128 timestamp) external;
    function finalizeStreams() external;
}
```

`finalizeStreams` is the hook function on each TIP-20 token and can only be called from the registry. When called, it decrements the `totalRewardPerSecond` by the aggregate rate of all streams ending at that time, and deletes the scheduled rate decrease entry from storage.

```solidity
function finalizeStreams(uint64 endTime) external;
```

### Interfaces

#### Rewards Structs

```solidity
interface ITIP20 {
    struct RewardStream {
        address funder;
        uint64 startTime;
        uint64 endTime;
        uint256 ratePerSecondScaled;
        uint256 amountTotal;
    }

    struct UserRewardInfo {
        address rewardRecipient;
        uint256 rewardPerToken;
        uint256 rewardBalance;
    }
}
```

#### Reward Distribution Management Functions

```solidity
function startReward(uint256 amount, uint32 seconds) external returns (uint64);
```

Creates a reward distribution to token holders without requiring token pre-approval. Returns streamId of 0 for instant distributions (seconds == 0) or a unique streamId for streaming rewards.

```solidity
function cancelReward(uint64 id) external returns (uint256 refund);
```

Cancels an active reward stream associated with the id, only callable by the creator. Transfers the undistributed amount to the stream creator and returns that value.

```solidity
function getStream(uint64 id) external view returns (address funder, uint64 startTime, uint64 endTime, uint256 ratePerSecondScaled, uint256 amountTotal);
```

Returns details of the reward stream associated with id.

#### User Reward Functions

```solidity
function setRewardRecipient(address newRewardRecipient) external;
```

Sets the reward recipient for the caller.

```solidity
function claimRewards() external returns (uint256);
```

Claims all pending rewards for the caller. Returns the reward amount claimed.

```solidity
function userRewardInfo(address user) external view returns (address rewardRecipient, uint256 rewardPerToken, uint256 rewardBalance);
```

Gets the reward info for a user, including their reward recipient address, their `rewardPerToken` snapshot at last interaction, and their unclaimed reward balance.

#### State Variables

```solidity
function globalRewardPerToken() external view returns (uint256);
```

Cumulative rewards per unit token accumulator. This variable monotonically increases as rewards are distributed over time.

```solidity
function lastUpdateTime() external view returns (uint64);
```

Timestamp of the last reward accrual update.

```solidity
function totalRewardPerSecond() external view returns (uint256);
```

Aggregate emission rate of all active streaming rewards, scaled by `ACC_PRECISION` (1e18).

```solidity
function optedInSupply() external view returns (uint128);
```

Total token supply that has opted in to receive rewards.

```solidity
function nextStreamId() external view returns (uint64);
```

The next stream ID that will be assigned when a new reward stream is created.

```solidity
function streams(uint64 id) external view returns (address funder, uint64 startTime, uint64 endTime, uint256 ratePerSecondScaled, uint256 amountTotal);
```

Returns the reward stream details for the given stream ID.

```solidity
function scheduledRateDecrease(uint64 timestamp) external view returns (uint256);
```

Returns the total rate decrease scheduled at the given timestamp when streams end.

### Events

```solidity
event RewardScheduled(address indexed funder, uint64 indexed id, uint256 amount, uint32 durationSeconds);
event RewardCanceled(address indexed funder, uint64 indexed id, uint256 refund);
event RewardRecipientSet(address indexed holder, address indexed recipient);
```

### Errors

```solidity
error InvalidAmount(); // Amount provided is zero
error NoOptedInSupply(); // Cannot distribute instant rewards because no token holders have opted in
error NotStreamFunder(); // Caller is not the funder of the reward stream
error StreamInactive(); // Reward stream does not exist or has already ended
error PolicyForbids(); // Transfer policy denies authorization for sender or receiver
```