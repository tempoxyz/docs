import { Callout } from 'vocs/components'

# Fee Lifecycle

## Overview

When a user submits a transaction on Tempo, fees are paid in their chosen stablecoin (determined by the hierarchy above). If the validator prefers a different stablecoin, the Fee AMM automatically converts the user's payment to the validator's preferred token. This all happens transparently during transaction processing.

## Fee Flow Steps

::::steps

### User Submits Transaction

The transaction is submitted with the fee token determined by the preference hierarchy described above.

### Pre-Transaction Collection

Before the transaction executes, the `FeeManager` contract collects the maximum possible fee amount from the user:

- Verifies the user has sufficient balance in their chosen fee token
- Checks if the Fee AMM has enough liquidity (if conversion is needed)
- Collects the maximum fee amount based on the transaction's gas limit

If either check fails, the transaction is rejected before execution.

### Transaction Execution

The transaction executes normally. The actual gas consumed may be less than the maximum that was collected.

### Post-Transaction Refund

After execution, the `FeeManager`:

- Calculates the actual fee owed based on gas used
- Refunds any unused tokens to the user
- Queues the actual fee amount for conversion (if needed)

### Fee Swap Queuing

If the user's fee token differs from the validator's preferred token, the fee is added to a pending fee swap queue for that token pair. The swap doesn't execute immediately—it's batched with all other fees collected during the block.

<Callout type="note">
  If the user's fee token matches the validator's preference, no conversion is needed and the fee goes directly to the validator.
</Callout>

### End-of-Block Settlement

At the end of each block, the protocol:

1. Calls `executePendingFeeSwaps()` on the Fee AMM for each token pair
2. Executes all pending fee swaps at a fixed rate of **0.997** (validator receives 0.997 of their token per 1.0 user token paid)
3. Updates the AMM pool reserves
4. Transfers the converted tokens to the validator's account

This batched settlement prevents MEV attacks like sandwiching or backrunning individual fee payments.

::::

## Fee Swap Mechanics

### Fixed Rate Conversion

Fee swaps always execute at a fixed rate of **m=0.997**:

```
validatorTokenOut = userTokenIn × 0.997
```

This means:
- User pays 1.0 USDC for fees
- Validator receives 0.997 USDT (if that's their preferred token)
- The 0.003 (0.3%) difference goes to liquidity providers as a fee

### Pool Rebalancing

After fee swaps drain the validator token from the pool, arbitrageurs can rebalance it by swapping in the opposite direction at a rate of **0.9985**:

```
userTokenOut = validatorTokenIn ÷ 0.9985
```

This creates a natural incentive for liquidity providers and arbitrageurs to keep pools balanced.

## Example Flow

Let's walk through a complete example:

1. **Alice** wants to send a transaction and pays fees in **USDC** (her preferred token)
2. **Validator** prefers to receive fees in **USDT**
3. Alice's transaction has a max fee of 1.0 USDC
4. The FeeManager collects 1.0 USDC from Alice before execution
5. Transaction executes and uses 0.8 USDC worth of gas
6. The FeeManager refunds 0.2 USDC to Alice
7. The remaining 0.8 USDC is queued for conversion
8. At block end, the Fee AMM swaps 0.8 USDC → 0.7976 USDT (0.8 × 0.997)
9. Validator receives 0.7976 USDT
10. Liquidity providers earn 0.0024 USDT from the 0.3% fee

## Gas Costs

The fee conversion process adds minimal overhead to transactions:

- **Pre-transaction**: ~5,000 gas for balance and liquidity checks
- **Post-transaction**: ~3,000 gas for refund and queue operations
- **Block settlement**: Amortized across all transactions in the block

For complete technical specifications, see the [Fee AMM Protocol Specification](/protocol/transactions/fee-amm).
