# TIP-20 Streaming Rewards

## Overview

This feature lets a TIP-20 token contract (and therefore, implicitly, the TIP-20 token issuer) efficiently stream rewards, in the same token, pro-rata to opted-in holders. No external staking workflow or rebasing tokens are required. 

At a high level, the functionality works as follows:
1. **Setting up Streams**: A authorized party can create a stream by funding the reward pool and scheduling emissions. The stream records its funder, start and end timestamps, emission rate, and total amount. When a stream with positive duration begins, the token schedules a future rate decrease at its end time and registers that timestamp with the `TIP20RewardsRegistry` precompile. Canceling a stream removes that registration.
2. **Participation**: Holders opt in by setting a non-zero reward recipient. The token tracks an `optedInSupply`, updates snapshots on every opt-in/out. 
3. **Transfers and balance changes**: Any mint, burn, or transfer first accrues rewards to the current timestamp, then updates sender and receiver snapshots so that reward balances remain in sync without iterating over holders.
4. **Claims**: Any holder can call `claimRewards`, which moves the holder's accrued rewards (`rewardBalance`) from the pool into their transferable balance. Claimed tokens join the opted-in supply if the recipient remains opted in.
5. **Finalization**: The first transaction in the block is a system transaction that finalizes streams (by calling `finalizeStreams` on the registry). This calls back into each token that has streams ending at the current timestamp to accrue rewards up to that moment, apply the corresponding rate reduction, and clear the pending entry. 

All potential token movements must honor TIP-403 transfer policy checks, including the initial funding transfer, refunds on cancellation, and claims. 
The full specification is available [here](/protocol/specs/RewardDistribution).

## Setting up/ Cancelling a Stream
An issuer funds and schedules emissions on-chain by starting a reward stream.

```solidity [Example.sol]
TIP20 token = TIP20(0x20c0000000000000000000000000000000000004);

uint256 rewardAmount = 1_000_000 * 10 ** token.decimals();
uint256 streamDuration = 90 days;

// Transfer tokens into the reward pool and begin streaming
uint64 streamId = token.startReward(rewardAmount, streamDuration);

// ... later, if plans change:
token.cancelReward(streamId);
```

A stream deposits tokens into the reward pool and increases a global reward-per-token accumulator that each holder settles against whenever balances or reward preferences change. A `streamDuration` of 0 applies its entire amount to the accumulator at once. Streams may be canceled early through `cancelReward`, refunding the remaining balance when policy checks permit.

## Participation

Accounts can control participation by setting a reward recipient. 

```solidity [Example.sol]
TIP20 token = TIP20(0x20c0000000000000000000000000000000000004);

address delegate = 0xdeadbeefdeadbeefdeadbeefdeadbeefdeadbeef;

// Opt in and send future rewards to the chosen delegate
token.setRewardRecipient(delegate);

// Off-chain bookkeeping can read the accrued amount
(, , uint256 pending) = token.userRewardInfo(address(this));

// Redeem the accrued balance; TIP-403 checks run before the transfer
uint256 claimed = token.claimRewards();

// Opt out by clearing the recipient
token.setRewardRecipient(address(0));
```

Calling `setRewardRecipient` with a non-zero address opts the caller in and updates both the opted-in supply and the holder's snapshot of the accumulator. Setting the recipient to the zero address opts the account out. Accrued value is tracked in `rewardBalance` and is redeemed with `claimRewards`, which performs TIP-403 authorization, refreshes the accumulator, and transfers up to the pool's balance back to the caller. 

## Stream Lifecycle

The registry coordinates accrual when streams begin, end, or are cancelled.

```solidity [Example.sol]
TIP20 token = TIP20(0x20c0000000000000000000000000000000000004);
TIP20RewardsRegistry registry = TIP20RewardsRegistry(0x3000000000000000000000000000000000000000);


uint256 rewardAmount = 1_000_000 * 10 ** token.decimals();
uint256 streamDuration = 90 days;

uint64 quarterlyStream = token.startReward(rewardAmount, streamDuration);

// ... time passes; if the funder needs to halt emissions early:
uint256 refund = token.cancelReward(quarterlyStream);

// Otherwise, when the stream reaches its scheduled end block (and has not been
// canceled), the chain's system transaction invokes the registry:
registry.finalizeStreams();

// The registry calls back into the token, advancing the accumulator.
```
