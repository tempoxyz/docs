import * as Card from '../../../components/Card.tsx'
import * as Demo from '../../../components/guides/Demo.tsx'
import * as Step from '../../../components/guides/steps'
import LucideBook from '~icons/lucide/book'
import LucideCoins from '~icons/lucide/coins'
import LucideFileCode from '~icons/lucide/file-code'
import LucideLayers from '~icons/lucide/layers'

# Sponsor User Fees

Enable gasless transactions by sponsoring transaction fees for your users. Tempo's native fee sponsorship allows applications to pay fees on behalf of users, improving UX and removing friction from payment flows.

## Demo

<Demo.Container name="Sponsor User Fees" footerVariant="source" src="tempoxyz/tempo-ts/tree/main/examples/payments">
  <Step.CreateSponsorAccount stepNumber={1} />
  <Step.FundSponsorAccount stepNumber={2} />
  <Step.Connect stepNumber={3} />
  <Step.AddFunds stepNumber={4} />
  <Step.SendSponsoredPayment stepNumber={5} last />
</Demo.Container>

## Steps

::::steps

### Create and fund sponsor account

Create and fund an account to sponsor transaction fees for your users.

<Demo.Container name="Sponsor User Fees" footerVariant="source" src="tempoxyz/tempo-ts/tree/main/examples/payments">
  <Step.CreateSponsorAccount stepNumber={1} />
  <Step.FundSponsorAccount stepNumber={2} />
</Demo.Container>

:::code-group

```tsx twoslash [CreateAndFundSponsorAccount.ts]
// @noErrors
import { privateKeyToAccount } from 'viem/accounts'
import { useClient } from 'wagmi'

export function CreateSponsorAccount() {
  const client = useClient()

  const handleClick = async () => {
    const privateKey = `0x${Array.from({ length: 64 }, () =>        // [!code hl]
      Math.floor(Math.random() * 16).toString(16),                  // [!code hl]
    ).join('')}` as `0x${string}`                                   // [!code hl]
    const sponsorAccount = privateKeyToAccount(privateKey)                 // [!code hl]
    await client.request<any>({                                     // [!code hl]
      method: 'tempo_fundAddress',                                 // [!code hl]
      params: [sponsorAccount.address],                                   // [!code hl]
    })                                                             // [!code hl]
  }

  return (
    <button onClick={handleClick}>
      Create and fund sponsor account
    </button>
  )
}
```

```tsx twoslash [config.ts] filename="config.ts"
// @noErrors
import { createConfig, http } from 'wagmi'
import { tempo } from 'tempo.ts/chains'
import { webAuthn } from 'tempo.ts/wagmi'

export const config = createConfig({
  chains: [tempo({ feeToken: '0x20c0000000000000000000000000000000000001' })],
  connectors: [webAuthn()],
  transports: {
    [tempo.id]: http(),
  },
})
```

:::

### Sponsor your user's payments

Now you can pass your sponsor account as the `feePayer` parameter when sending a payment.

See the [Send a payment](/guide/payments/send-a-payment) guide for more details on how to send a payment.


<Demo.Container name="Sponsor User Fees" footerVariant="source" src="tempoxyz/tempo-ts/tree/main/examples/payments">
  <Step.CreateSponsorAccount stepNumber={1} />
  <Step.FundSponsorAccount stepNumber={2} />
  <Step.Connect stepNumber={3} />
  <Step.AddFunds stepNumber={4} />
  <Step.SendSponsoredPayment stepNumber={5} last />
</Demo.Container>

:::code-group

```tsx twoslash [SendSponsoredPayment.tsx]
import React from 'react'
import { Hooks } from 'tempo.ts/wagmi'
import { parseUnits } from 'viem'

// @noErrors
export function SendSponsoredPayment({ sponsorAccount }: { sponsorAccount: any }) {
  const [recipient, setRecipient] = React.useState<string>('')

  const sendPayment = Hooks.token.useTransferSync() // [!code hl]

  return (
    <>
      <div>
        <label>Recipient address</label>
        <input
          type="text"
          value={recipient}
          onChange={(e) => setRecipient(e.target.value)}
        />
      </div>
      <button // [!code hl]
        disabled={sendPayment.isPending} // [!code hl]
        type="button" // [!code hl]
        onClick={() => // [!code hl]
          sendPayment.mutate({ // [!code hl]
            amount: parseUnits('100', 6), // [!code hl]
            to: recipient as `0x${string}`, // [!code hl]
            token: '0x20c0000000000000000000000000000000000001', // [!code hl]
            feePayer: sponsorAccount, // [!code hl] // [!code focus]
          }) // [!code hl]
        } // [!code hl]
      > {/* [!code hl] */}
        {sendPayment.isPending ? 'Sending...' : 'Send Payment'} {/* [!code hl] */}
      </button> {/* [!code hl] */}
    </>
  )
}
```

```tsx twoslash [config.ts] filename="config.ts"
// @noErrors
import { createConfig, http } from 'wagmi'
import { tempo } from 'tempo.ts/chains'
import { webAuthn } from 'tempo.ts/wagmi'

export const config = createConfig({
  chains: [tempo({ feeToken: '0x20c0000000000000000000000000000000000001' })],
  connectors: [webAuthn()],
  transports: {
    [tempo.id]: http(),
  },
})
```

:::

## Next Steps

Now that you've implemented fee sponsorship, you can:
- Learn more about [Account Abstraction transactions](/documentation/protocol/transactions/spec-account-abstraction#fee-payer-signature-details) and fee payer signature details
- Explore [Batch Transactions](/guide/use-accounts/batch-transactions) to sponsor multiple operations at once
- Understand how to [Pay Fees in Any Stablecoin](/guide/payments/pay-fees-in-any-stablecoin) 

::::

## Recipes

### Use SDK helpers

Tempo's SDK provides helpers to simplify fee sponsorship implementation:

```ts
import { withFeePayer } from 'tempo.ts/viem'

// Create a client with fee payer support
const sponsoredClient = client.extend(
  withFeePayer({
    feePayer: sponsorAccount,
    feeToken: sponsorPreferredToken,
  })
)

// User can now send transactions without paying fees
const hash = await sponsoredClient.sendTransaction({
  calls: [
    { data: '0x...', to: '0x...' },
  ],
})
```

### Onboarding new users

Remove friction for new users who don't have tokens yet by sponsoring their first transactions:

```ts
// New user can interact with your app immediately
// You sponsor their first few transactions
await sponsoredClient.sendTransaction({
  calls: [
    { data: '0x...', to: '0x...' },
  ],
})
```

### Sponsor payment transactions

Improve payment UX by sponsoring fees for user payment transactions:

```ts
// User sends payment, you sponsor the fee
await sponsoredClient.token.transfer({
  token: usdcAddress,
  to: merchantAddress,
  amount: parseUnits('100', 6),
})
```

## Best practices

1. **Set sponsorship limits**: Implement daily or per-user limits to control costs
2. **Monitor expenses**: Track sponsorship costs regularly to stay within budget

```ts
// Track sponsored transactions
const sponsoredTransactions = await getSponsoredTransactions({
  feePayer: sponsorAddress,
  fromBlock: startBlock,
  toBlock: endBlock,
})

const totalFees = sponsoredTransactions.reduce(
  (sum, tx) => sum + tx.feeAmount,
  0n
)
```

3. **Consider selective sponsorship**: Only sponsor fees for specific operations or user segments
4. **Educate users**: Clearly communicate when fees are being sponsored

### Security Considerations

- **Transaction-specific**: Fee payer signatures are tied to specific transactions
- **No delegation risk**: Fee payer can't execute arbitrary transactions
- **Balance checks**: Network verifies fee payer has sufficient balance
- **Signature validation**: Both signatures must be valid

## Learning Resources

<Card.Container>
  <Card.Link
    description="Deep dive into how fee sponsorship works under the hood"
    href="/guide/use-accounts/fee-sponsorship"
    icon={LucideBook}
    title="Fee Sponsorship Specification"
  />
  <Card.Link
    description="Technical specification for AA transactions and fee payer signature details"
    href="/documentation/protocol/transactions/spec-account-abstraction"
    icon={LucideFileCode}
    title="Account Abstraction Transaction Spec"
  />
  <Card.Link
    description="Learn how to sponsor fees for multiple operations at once"
    href="/guide/use-accounts/batch-transactions"
    icon={LucideLayers}
    title="Batch Transactions Guide"
  />
  <Card.Link
    description="Understand fee token selection and how to pay with different stablecoins"
    href="/guide/payments/pay-fees-in-any-stablecoin"
    icon={LucideCoins}
    title="Pay Fees in Any Stablecoin"
  />
</Card.Container>
