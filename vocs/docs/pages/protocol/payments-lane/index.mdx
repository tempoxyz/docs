# Payments Lane

Introduces a second consensus gas constraint for **non-payment** transactions while leaving existing `gasLimit` / `gasUsed` and the basefee mechanism unchanged. A new field (i.e., `generalGasLimit`) is added to the header (`TempoHeader`) while leaving existing consensus fields unchanged.

Transactions are classified as payments/non-payments as a pure function of the transaction bytes (no state access). For a block to be valid, total `gasUsed` must be less than the `gasLimit` **and** the gas used by non-payment transactions must be less than `generalGasLimit`.

This dual gas limit system guarantees payment throughput during network congestion without creating fee market complexity or allowing address-based manipulation.

## Motivation

Preserve throughput and predictable inclusion for simple payments under heavy non-payment demand (e.g., DeFi activity, complex smart contracts) without changing the fee market or canonical header fields.


## Key Features

1. **Dual gas limit system**: Blocks enforce two separate constraints:
   - Standard `gasLimit` applies to all transactions
   - New `generalGasLimit` caps only non-payment transactions

2. **Pure classification function**: Payment transactions are identified by `tx.to` address prefix `0x20c000000…` (TIP-20 tokens) with no state access needed, enabling deterministic verification

3. **Preserved throughput for payments**: During network congestion, simple payment transactions are guaranteed blockspace

4. **Single fee market**: Payments and non-payments pay the same basefee—no separate pricing, just different capacity constraints

5. **Protocol-reserved address space**: The `0x20c000000…` prefix is protected; only the TIP-20 factory can deploy contracts there, preventing classification spoofing

6. **Backwards incompatible**: Consensus-breaking change requiring all nodes to upgrade at activation


## Specification

### 1. Transaction Classification (Pure, Versioned)

A chain-config constant `ClassifierID` selects the active rule set.

**Classifier v1:** `isPaymentTx(tx) == true` if and only if `tx.to` has the reserved 14-byte prefix `0x20c000000…` corresponding to TIP-20 factory-deployed token contracts.

**Note:** Only the **outer** transaction envelope is considered; internal calls and state are ignored. Later forks may change the classifier by bumping `ClassifierID`.

### 2. Custom Block Header Fields

Adds a new limit, `generalGasLimit`, as a custom field in the header. The total amount of gas consumed by non-payment transactions in the block must be smaller than `generalGasLimit`.

**Consensus fields unchanged:** `gasLimit`, `gasUsed`, `baseFeePerGas`, etc.

### 3. Lane Ordering (Consensus)

No specific lane ordering is required. General priority ordering can be used and is recommended.

Any system transactions (such as those required as part of the Fee AMM) must be the last transaction in the block, and no regular transaction can follow those.

### 4. Gas Accounting & Validity (Consensus)

Validity of a block requires that:

```
gasUsed         <= gasLimit
generalGasUsed  <= generalGasLimit
```

Where:
- `gasUsed` is the sum of gas consumed by all transactions in the block
- `generalGasUsed` is the sum of gas consumed by non-payment transactions only:
  ```
  generalGasUsed = Σ gasConsumed(tx[i]) for all i where !isPaymentTx(tx[i])
  ```

`gasConsumed` includes intrinsic gas and gas burned by reverts, as in the existing protocol.

**Important:** Reverts do not alter classification; intrinsic gas counts toward the same meter as the enclosing transaction.

### 5. Fee Market

No changes to basefee or pricing rules. Payment transactions pay the same basefee as non-payment transactions. The additional meter only caps aggregate non-payment gas, ensuring payments maintain throughput without introducing a second basefee surface.

### 6. JSON-RPC Surface (Informative)

- `eth_getBlockBy*`: expose new field `generalGasUsed` from header.
- `eth_getTransactionReceipt`: optionally include `paymentClassification: true|false` (derivable off-chain from `tx`).
