import { Callout } from 'vocs/components'

# Token Preferences

## Abstract

This spec lays out how the default fee token for a transaction is determined.

## Motivation

On Tempo, users can pay gas fees in any stablecoin, as long as that stablecoin either is accepted by the validator **or** has sufficient liquidity on the enshrined fee AMM. 

In determining *which* token a user pays fees in, we want to maximize customizability (so that wallets or users can implement more sophisticated UX than is possible at the protocol layer), minimize surprise (particularly surprises in which a user pays fees in a stablecoin they did not expect to), and have sane default behavior so that users can begin using basic functions like payments even using wallets that are not customized for Tempo support.

We also want to limit the complexity of block building, in order to minimize denial-of-service attacks. The rules in this spec ensure that the fee token of every transaction in a block can be statically determined from the state at the top of the block and the contents of those transactions, without having to execute any transactions.

## Order of preference

There are currently two sources of token preference, with this order of precedence:

1. **User preference** (set on the FeeManager contract by the transaction sender)
2. **Validator preference** (set by the validator/block producer)

The protocol checks preferences at each of these levels, stopping at the first one at which a preference is specified. At that level, the protocol performs the following checks. If any of the checks fail, the transaction is invalid:

* The token must be a TIP-20 token whose currency is USD.
* The user must have sufficient balance in that token to pay the `gasLimit` on the transaction.
* There must be sufficient liquidity on the [fee AMM](#fee-amm) to support the transaction (no liquidity is needed if the user preference is the same as the validator preference).

<Callout type="note">
  Transaction-level `fee_token` fields and contract-level preferences are not currently implemented, though they may be added in future versions.
</Callout>

## User Level

Users can specify a fee token preference for their transactions. This preference overrides the validator's default fee token.

To set their preference, users call the `setUserToken` function on the FeeManager precompile:

```solidity
function setUserToken(address token) external;
```

This method can only be called directly by the user, not through account abstraction or smart contracts. Setting the token to the zero address removes the user's preference. Once set, all future transactions from that user will use this token for fees, unless the user has insufficient balance.

## Validator Level

If the user has not set a fee token preference (or set it to zero address), then the fee token for transactions is the validator's preferred token.

Validators can set their fee preference by calling the `setValidatorToken` function on the FeeManager precompile:

```solidity
function setValidatorToken(address token) external;
```

This sets the default fee token for all users who haven't set their own preference. If a user doesn't have sufficient balance in the validator's preferred token, the transaction is invalid.
